<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JUGADOR - RIVAL M√ÅS D√âBIL</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #000000; --primary: #00d2ff; --accent: #f1c40f; --danger: #ff0055; --success: #00ff9d; --glass: rgba(255,255,255,0.08); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin:0; background:var(--bg); color:white; font-family:'Outfit'; height:100vh; display:flex; flex-direction:column; overflow:hidden; }

        header { 
            position: fixed; top: 0; left: 0; width: 100%; height: 85px;
            display: grid; grid-template-columns: 1fr auto; align-items: center; 
            padding: 10px 20px; 
            padding-top: max(10px, env(safe-area-inset-top)); 
            background: #0a0a0a; border-bottom: 1px solid #333; z-index: 1000;
        }
        .header-info { display: flex; flex-direction: column; text-align: left; }
        .app-title { font-weight:900; font-size:1.3rem; letter-spacing:1px; color:var(--primary); text-transform:uppercase; margin:0; line-height: 1.1; }
        .app-subtitle { font-size: 0.8rem; color: #888; margin-top: 5px; font-weight: 300; }
        .header-timer { font-size: 2.8rem; font-weight: 700; color: white; min-width: 80px; text-align: right; line-height: 1; }
        .timer-warn { color: var(--accent); }
        .timer-crit { color: var(--danger); animation: pulse 0.5s infinite; }
        .highlight-name { color: var(--accent); font-weight: bold; }

        .screen { position:absolute; top:0; left:0; width:100%; height:100%; display:none; flex-direction:column; align-items:center; justify-content:center; background:var(--bg); z-index:5; }
        .active { display:flex; }

        #gameScreen { padding-top: 120px; justify-content: flex-start; }
        .bank-info { width:100%; background:#111; padding:15px; text-align:center; border-bottom:1px solid #333; position: relative; z-index: 50; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .bank-total-label { font-size:0.8rem; color:#888; text-transform: uppercase; letter-spacing: 1px; }
        .bank-total-val { font-size:3rem; color:var(--accent); font-weight:900; line-height: 1; text-shadow: 0 0 10px rgba(241,196,15,0.3); }

        #ladderContainer { flex:1; display:flex; flex-direction: column-reverse; justify-content:center; align-items:center; width:100%; padding:20px; gap:5px; overflow-y: auto; }
        .step { width:90%; padding:8px; text-align:center; background:#1a1a1a; border-radius:8px; font-weight:bold; color:#555; transition:0.3s; font-size:1.2rem; display: flex; justify-content: center; align-items: center; }
        .step.active { background:var(--accent); color:black; transform:scale(1.1); box-shadow:0 0 20px rgba(241,196,15,0.4); z-index:2; }

        .login-box { width:80%; text-align:center; }
        input { width:100%; padding:15px; background:#222; border:none; color:white; font-size:1.2rem; text-align:center; border-radius:10px; margin-bottom:15px; }
        .btn-start { width:100%; padding:15px; background:var(--primary); border:none; font-weight:bold; font-size:1.2rem; border-radius:10px; color:black; text-transform:uppercase; }

        #introScreen { background: black; text-align:center; padding:20px; }
        .intro-text-1 { font-size:2rem; font-weight:300; animation: fadeIn 1s forwards; opacity:0; }
        .intro-text-2 { font-size:1.5rem; margin-top:10px; color:#888; animation: fadeIn 1s forwards 1s; opacity:0; }
        .intro-logo { font-size:3rem; font-weight:900; margin-top:20px; color:var(--primary); text-transform:uppercase; text-shadow:0 0 20px var(--primary); animation: introReveal 1.5s forwards 2s; opacity:0; transform:scale(0.5); }

        .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:200; display:none; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding: 20px; }
        
        #votingGrid { display:grid; grid-template-columns:1fr 1fr; gap:15px; width:90%; margin-top:20px; }
        .vote-btn { padding:20px; background:#222; border:1px solid #444; color:white; font-weight:bold; font-size:1rem; border-radius:10px; }
        .vote-btn:active { background:var(--primary); color:black; }

        #timesUpScreen { background: rgba(200, 0, 0, 0.95); }
        .tu-icon { font-size: 5rem; animation: shake 0.5s infinite; }
        
        #eliminatedScreen { background:rgba(0,0,0,0.98); }
        .elim-icon { font-size:6rem; margin-bottom:20px; color: var(--danger); text-shadow: 0 0 30px var(--danger); }
        .elim-text { font-size:1.8rem; font-weight:bold; color: white; line-height: 1.4; }

        #penaltyScreen { background: #000; padding-top: 90px; }
        .penalty-container { display: flex; flex-direction: column; width: 100%; height: 100%; justify-content: center; gap: 30px; }
        .p-row { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .p-name { width: 80px; text-align: right; font-weight: bold; font-size: 1.2rem; color: var(--primary); }
        .ovals-wrapper { display: flex; gap: 8px; }
        .oval { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #333; background: #111; transition: 0.3s; }
        .oval.correct { background: var(--success); box-shadow: 0 0 10px var(--success); border-color: var(--success); }
        .oval.wrong { background: var(--danger); box-shadow: 0 0 10px var(--danger); border-color: var(--danger); }
        .oval.current { border-color: var(--accent); animation: pulse 1s infinite; }

        #winnerScreen { background: radial-gradient(circle at center, #222 0%, #000 100%); z-index: 3000; }
        .w-trophy { font-size: 6rem; animation: bounce 2s infinite; text-shadow: 0 0 50px gold; }
        .w-title { font-size: 1.5rem; color: #888; text-transform: uppercase; margin-top: 20px; }
        .w-name { font-size: 3.5rem; color: var(--primary); font-weight: 900; text-transform: uppercase; line-height: 1.1; margin: 10px 0; text-shadow: 0 0 20px var(--primary); animation: winnerPulse 2s infinite alternate; }
        .w-msg { font-size: 1.2rem; color: white; margin-bottom: 20px; }
        .w-amount { font-size: 4rem; color: var(--accent); font-weight: 900; text-shadow: 0 0 30px var(--accent); }
        
        #loserFinalScreen { background: rgba(0,0,0,0.98); z-index: 3000; }
        .l-msg { font-size: 1.5rem; color: white; line-height: 1.5; max-width: 80%; }
        
        #introFinalScreen { background: rgba(0,0,0,0.95); z-index: 2500; }
        .if-title { font-size: 1.5rem; color: var(--accent); margin-bottom: 30px; letter-spacing: 5px; }
        .if-vs { font-size: 4rem; font-weight: 900; color: var(--danger); margin: 20px 0; font-style: italic; }
        .if-player { font-size: 2.5rem; font-weight: bold; color: white; }

        .confetti { position: absolute; width: 10px; height: 10px; background: red; animation: fall linear infinite; opacity: 0; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        @keyframes fadeIn { to { opacity:1; } }
        @keyframes pulse { 0%{opacity:0.8} 50%{opacity:1} 100%{opacity:0.8} }
        
        @keyframes introReveal { 
            to { opacity:1; transform:scale(1); text-shadow:0 0 40px var(--primary); } 
        }
        @keyframes winnerPulse { 
            to { transform:scale(1.05); text-shadow:0 0 40px var(--primary); } 
        }
    </style>
</head>
<body>

    <header>
        <div class="header-info">
            <div class="app-title">EL RIVAL M√ÅS D√âBIL</div>
            <div id="headerSubTitle" class="app-subtitle">Bienvenido al juego</div>
        </div>
        <div id="miniTimer" class="header-timer">20</div>
    </header>

    <div id="loginScreen" class="screen active">
        <div class="login-box">
            <h2 style="color:var(--primary)">INGRESA TU NOMBRE</h2>
            <input type="text" id="pName" placeholder="Nombre" maxlength="10">
            <button class="btn-start" onclick="enterGame()">JUGAR</button>
        </div>
    </div>

    <div id="introScreen" class="screen">
        <div id="intro1" class="intro-text-1">¬°Hola!</div>
        <div class="intro-text-2">Juguemos a...</div>
        <div class="intro-logo">EL RIVAL<br>M√ÅS D√âBIL</div>
    </div>

    <div id="gameScreen" class="screen">
        <div class="bank-info">
            <div class="bank-total-label">BANCO ACUMULADO</div>
            <div id="bankTotal" class="bank-total-val">$0</div>
        </div>
        <div id="ladderContainer"></div>
        <div id="waitingOverlay" class="overlay" style="background:rgba(0,0,0,0.8);">
            <div id="roundWaitMsg" style="font-size:1.5rem; color:var(--primary); font-weight:bold;">Esperando inicio...</div>
        </div>
    </div>

    <div id="penaltyScreen" class="screen">
        <h2 style="color:var(--accent); text-transform:uppercase; margin-bottom:40px;">Ronda Final</h2>
        <div class="penalty-container">
            <div class="p-row">
                <div id="penP1Name" class="p-name">P1</div>
                <div id="penP1Ovals" class="ovals-wrapper"></div>
            </div>
            <div class="p-row">
                <div id="penP2Name" class="p-name">P2</div>
                <div id="penP2Ovals" class="ovals-wrapper"></div>
            </div>
        </div>
    </div>

    <div id="timesUpScreen" class="overlay">
        <div class="tu-icon">‚è∞</div>
        <h1 style="font-size:3rem; margin:10px 0;">¬°TIEMPO!</h1>
        <p style="font-size:1.2rem;">Fin de la ronda.</p>
    </div>

    <div id="voteScreen" class="overlay">
        <h2 style="color:var(--accent)">¬øQUI√âN ES EL RIVAL M√ÅS D√âBIL?</h2>
        <div id="votingGrid"></div>
    </div>

    <div id="eliminatedScreen" class="overlay">
        <div class="elim-icon">‚ùå</div>
        <div id="elimMsg" class="elim-text">Has sido eliminado.</div>
    </div>

    <div id="introFinalScreen" class="overlay">
        <div class="if-title">GRAN FINAL</div>
        <div id="ifP1" class="if-player">JUGADOR 1</div>
        <div class="if-vs">VS</div>
        <div id="ifP2" class="if-player">JUGADOR 2</div>
    </div>

    <div id="winnerScreen" class="overlay">
        <div class="w-trophy">üèÜ</div>
        <div class="w-title">¬°FELICIDADES!</div>
        <div id="wName" class="w-name">NOMBRE</div>
        <div class="w-msg">T√ö HAS SIDO EL RIVAL M√ÅS FUERTE</div>
        <div style="font-size:0.9rem; color:#888; margin-top:10px;">HAS GANADO</div>
        <div id="wAmount" class="w-amount">$0</div>
    </div>

    <div id="loserFinalScreen" class="overlay">
        <div class="elim-icon" style="font-size:4rem; color:#888;">üíî</div>
        <div id="lMsg" class="l-msg"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName = "";
        let isEliminated = false;
        let currentRound = 1;
        let myEliminationRound = null;
        let isLoggedIn = false;      
        let currentPhase = 'waiting'; 
        
        const els = {
            login: document.getElementById('loginScreen'),
            intro: document.getElementById('introScreen'),
            game: document.getElementById('gameScreen'),
            penalty: document.getElementById('penaltyScreen'),
            vote: document.getElementById('voteScreen'),
            timesUp: document.getElementById('timesUpScreen'),
            elim: document.getElementById('eliminatedScreen'),
            winner: document.getElementById('winnerScreen'),
            introFinal: document.getElementById('introFinalScreen'),
            loserFinal: document.getElementById('loserFinalScreen'),
            
            ladder: document.getElementById('ladderContainer'),
            bank: document.getElementById('bankTotal'),
            waitOver: document.getElementById('waitingOverlay'),
            waitMsg: document.getElementById('roundWaitMsg'),
            vGrid: document.getElementById('votingGrid'),
            introName: document.getElementById('intro1'),
            headerSub: document.getElementById('headerSubTitle'),
            miniTimer: document.getElementById('miniTimer'),
            elimMsg: document.getElementById('elimMsg'),
            p1Name: document.getElementById('penP1Name'),
            p1Ovals: document.getElementById('penP1Ovals'),
            p2Name: document.getElementById('penP2Name'),
            p2Ovals: document.getElementById('penP2Ovals'),
            wName: document.getElementById('wName'),
            wAmount: document.getElementById('wAmount'),
            
            ifP1: document.getElementById('ifP1'),
            ifP2: document.getElementById('ifP2'),
            lMsg: document.getElementById('lMsg')
        };

        function enterGame() {
            const name = document.getElementById('pName').value.trim();
            if(!name) return;
            myName = name;
            socket.emit('registerPlayer', name);
            els.headerSub.innerHTML = `<span class="highlight-name">${myName}</span>, est√°s jugando a El Rival m√°s D√©bil`;
            els.login.classList.remove('active');
            els.intro.classList.add('active');
            els.introName.innerText = `¬°Hola ${name}!`;
            isLoggedIn = true;
            setTimeout(() => {
                els.intro.classList.remove('active');
                renderPhase(currentPhase); 
            }, 4500);
        }

        function renderPhase(phase) {
            els.vote.style.display = 'none';
            els.timesUp.style.display = 'none';
            els.introFinal.style.display = 'none';
            
            if(phase !== 'waiting') els.waitOver.style.display = 'none';
            els.game.classList.remove('active');
            els.penalty.classList.remove('active');

            if (isEliminated) {
                 if(phase === 'penalty' || phase === 'final_intro') els.penalty.classList.add('active');
                 else els.game.classList.add('active');
                 if(phase === 'waiting') {
                    els.waitOver.style.display = 'flex';
                    els.waitMsg.innerText = "ESPERANDO SIGUIENTE RONDA...";
                 }
                return; 
            }

            if (phase === 'penalty' || phase === 'final_intro') {
                els.penalty.classList.add('active');
                if (phase === 'final_intro') {
                     els.introFinal.style.display = 'flex';
                }
                return;
            }

            els.game.classList.add('active');

            if(phase === 'waiting') {
                els.waitOver.style.display = 'flex';
                els.waitMsg.innerText = "Atenci√≥n al Host...";
            }
            else if(phase === 'times_up') {
                els.timesUp.style.display = 'flex';
                if(navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]);
            }
            else if(phase === 'voting') {
                els.vote.style.display = 'flex';
            }
        }

        function createConfetti() {
            const colors = ['#f1c40f', '#e74c3c', '#3498db', '#9b59b6', '#2ecc71'];
            for(let i=0; i<50; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                c.style.animationDuration = (Math.random() * 2 + 2) + 's';
                c.style.animationDelay = Math.random() + 's';
                els.winner.appendChild(c);
            }
        }

        socket.on('gameReset', () => location.reload());

        socket.on('finalWinner', data => {
            if (myName.toUpperCase() === data.name.toUpperCase()) {
                els.winner.style.display = 'flex';
                els.wName.innerText = data.name;
                els.wAmount.innerText = `$${data.amount}`;
                createConfetti();
            } 
            else if (els.penalty.classList.contains('active') && !isEliminated) {
                els.loserFinal.style.display = 'flex';
                // MENSAJE CORREGIDO PARA PERDEDOR
                els.lMsg.innerHTML = `${myName},<br>GRACIAS POR PARTICIPAR.<br>PERO HAS PERDIDO EN LA FINAL DE<br><span style="color:var(--primary); font-weight:bold;">EL RIVAL M√ÅS D√âBIL</span>`;
            } 
            else {
                els.winner.style.display = 'flex';
                els.wName.innerText = data.name;
                els.wAmount.innerText = `$${data.amount}`;
                createConfetti();
            }
        });

        socket.on('playerEliminated', (name) => {
            if(name.toUpperCase() === myName.toUpperCase()) {
                isEliminated = true;
                myEliminationRound = currentRound;
                els.elimMsg.innerText = `${myName}, has sido el rival m√°s d√©bil de la ronda ${myEliminationRound}`;
                els.elim.style.display = 'flex';
                setTimeout(() => {
                    els.elim.style.display = 'none'; 
                    renderPhase(currentPhase);
                    els.headerSub.innerHTML = `<span class="highlight-name">${myName}</span>, has sido el rival m√°s d√©bil de la ronda ${myEliminationRound}`;
                    els.headerSub.style.color = "var(--danger)";
                    els.waitOver.style.display = 'flex';
                    els.waitMsg.innerText = "MODO ESPECTADOR";
                }, 4000);
            }
        });

        socket.on('timerUpdate', t => {
            els.miniTimer.innerText = t;
            if(t <= 5) els.miniTimer.className = 'header-timer timer-crit';
            else if(t <= 10) els.miniTimer.className = 'header-timer timer-warn';
            else els.miniTimer.className = 'header-timer';
        });

        socket.on('phaseChanged', (phase) => {
            currentPhase = phase; 
            if (!isLoggedIn) return; 
            renderPhase(phase);
        });

        socket.on('roundUpdate', r => {
            currentRound = r;
            if(!isEliminated && (els.waitMsg.innerText.includes("Esperando") || els.waitMsg.innerText.includes("Atenci√≥n"))) {
                els.waitMsg.innerText = `Esperando comenzar RONDA ${r}`;
            }
        });

        socket.on('bankState', state => {
            els.bank.innerText = `$${state.bankedTotal}`;
            els.ladder.innerHTML = '';
            state.chain.forEach((val, idx) => {
                const div = document.createElement('div');
                div.className = `step ${idx === state.chainIndex ? 'active' : ''}`;
                if (idx < state.chainIndex) div.style.opacity = '0.3';
                div.innerText = `$${val}`;
                els.ladder.appendChild(div);
            });
        });

        socket.on('playersUpdated', players => {
            els.vGrid.innerHTML = '';
            players.forEach(p => {
                if(p !== myName.toUpperCase()) {
                    const btn = document.createElement('button');
                    btn.className = 'vote-btn';
                    btn.innerText = p;
                    btn.onclick = () => {
                        socket.emit('vote', p);
                        els.vote.style.display = 'none';
                        els.waitOver.style.display = 'flex';
                        els.waitMsg.innerHTML = `HAS VOTADO POR:<br><span style="color:var(--danger); font-size:2rem">${p}</span>`;
                    };
                    els.vGrid.appendChild(btn);
                }
            });
        });

        socket.on('finalState', final => {
            els.ifP1.innerText = final.p1.name;
            els.ifP2.innerText = final.p2.name;

            els.p1Name.innerText = final.p1.name;
            els.p2Name.innerText = final.p2.name;
            
            els.p1Ovals.innerHTML = '';
            const maxSlots = Math.max(5, final.p1.history.length + 1);
            for(let i=0; i<maxSlots; i++) {
                const div = document.createElement('div');
                div.className = 'oval';
                if (i < final.p1.history.length) {
                    div.classList.add(final.p1.history[i] ? 'correct' : 'wrong');
                } else if (i === final.p1.history.length && final.turn === 0) {
                    div.classList.add('current');
                }
                els.p1Ovals.appendChild(div);
            }

            els.p2Ovals.innerHTML = '';
            const maxSlots2 = Math.max(5, final.p2.history.length + 1);
            for(let i=0; i<maxSlots2; i++) {
                const div = document.createElement('div');
                div.className = 'oval';
                if (i < final.p2.history.length) {
                    div.classList.add(final.p2.history[i] ? 'correct' : 'wrong');
                } else if (i === final.p2.history.length && final.turn === 1) {
                    div.classList.add('current');
                }
                els.p2Ovals.appendChild(div);
            }
        });
    </script>
</body>
</html>
