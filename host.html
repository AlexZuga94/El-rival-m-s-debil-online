<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HOST - RIVAL M√ÅS D√âBIL</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --primary: #00d2ff; --accent: #f1c40f; --danger: #ff0055; --success: #00ff9d; --glass: rgba(255,255,255,0.08); }
        * { box-sizing: border-box; }
        body { margin:0; padding:10px; background:var(--bg); color:white; font-family:'Outfit'; height: 100dvh; width: 100vw; display:flex; flex-direction: column; gap:10px; overflow:hidden; }
        
        header { flex-shrink: 0; display:flex; justify-content:space-between; align-items:center; background:var(--glass); padding:0 20px; border-radius:12px; height: 70px; }
        .brand { font-weight:900; font-size:1.2rem; color:var(--primary); text-transform:uppercase; }
        .timer-box { font-size:2.5rem; font-weight:700; color:var(--primary); }
        
        .bank-box { text-align:right; display:flex; flex-direction:column; justify-content:center; }
        .bank-row { display:flex; justify-content:flex-end; gap:10px; align-items:center; }
        .bank-label { font-size:0.7rem; color:#888; text-transform: uppercase; }
        .bank-val { font-size:1.2rem; color:white; font-weight:bold; width: 80px; text-align: right; }
        .total-val { color: var(--accent); font-size: 1.4rem; }

        .main-grid { flex: 1; display:grid; grid-template-columns: 250px 1fr 320px; gap:10px; min-height: 0; }
        .panel { background:var(--glass); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:15px; display:flex; flex-direction:column; gap:10px; height: 100%; overflow: hidden; }
        
        .btn { padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; text-transform:uppercase; color:white; background:rgba(255,255,255,0.1); text-align:left; font-size: 0.9rem; transition: all 0.2s; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .btn-next-step { border: 2px solid var(--primary); background: rgba(0, 210, 255, 0.2); box-shadow: 0 0 10px var(--primary); }
        .btn.active { background:var(--primary); color:black; }
        .btn-danger { color:var(--danger); border:1px solid var(--danger); }
        
        .btn-intro { background: #e91e63; color: white; margin-bottom: 5px; text-align: center; border: 1px solid #ff6090; }
        .btn-phrase { background: #673ab7; color: white; margin-bottom: 10px; text-align: center; border: 1px solid #9575cd; }
        .btn-reset { margin-top: auto; background: #300; border: 1px solid #500; color: #f88; text-align: center; flex-shrink: 0; }

        .center-panel { display: flex; flex-direction: column; padding: 10px; position: relative; } 
        .turn-banner { text-align: center; background: rgba(0, 210, 255, 0.1); padding: 5px; border-radius: 5px; border: 1px solid var(--primary); color: var(--primary); font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; }

        .question-area { flex: 1; overflow-y: auto; padding: 20px; background: rgba(0,0,0,0.3); border-left: 4px solid var(--primary); border-radius: 8px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .voting-area { display: none; flex: 1; overflow-y: auto; background: rgba(0,0,0,0.5); border-radius: 8px; padding: 10px; }
        
        .pre-final-msg { display:none; flex: 1; flex-direction:column; justify-content: center; align-items: center; text-align: center; }
        .pf-text { font-size: 2.5rem; font-weight: 900; color: var(--accent); text-transform: uppercase; animation: pulse 2s infinite; }

        .vote-card { background: #222; margin-bottom: 5px; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; font-size: 1.1rem; }
        .voter-name { color: #888; font-size: 0.9rem; }
        .target-name { color: var(--danger); font-weight: bold; }
        
        .vote-alert { padding: 15px; text-align: center; font-weight: 900; font-size: 1.2rem; border-radius: 8px; margin-bottom: 10px; display: none; }
        .alert-elim { background: var(--danger); color: white; }
        .alert-tie { background: var(--accent); color: black; }

        /* ESTILOS DEL GANADOR (Z-INDEX ALTO PARA QUE SE VEA SIEMPRE) */
        .winner-banner { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; animation: fadeIn 1s ease; position: absolute; top:0; left:0; background: rgba(0,0,0,0.9); z-index: 100; border-radius: 8px; }
        .wb-title { color: var(--accent); font-size: 1.2rem; letter-spacing: 3px; font-weight: 900; margin-bottom: 15px; text-transform: uppercase; }
        .wb-name { font-size: 4rem; font-weight: 900; color: white; text-shadow: 0 0 30px var(--primary); margin-bottom: 20px; line-height: 1; }
        .wb-amount-label { color: #888; font-size: 0.9rem; text-transform: uppercase; }
        .wb-amount { font-size: 3rem; color: var(--success); font-weight: bold; text-shadow: 0 0 20px var(--success); }

        #hostLadder { display: flex; gap: 5px; justify-content: center; align-items: center; padding: 5px; background: rgba(0,0,0,0.5); border-radius: 5px; margin-bottom: 10px; overflow-x: auto; white-space: nowrap; flex-shrink: 0; }
        .h-step { padding: 5px 10px; background: #222; border-radius: 4px; font-size: 0.8rem; color: #555; }
        .h-step.active { background: var(--accent); color: black; font-weight: bold; transform: scale(1.1); }

        .controls-area { flex-shrink: 0; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; height:80px; }
        .big-btn { border:none; border-radius:8px; font-weight:900; font-size:1.1rem; cursor:pointer; text-transform:uppercase; color: white; transition: 0.2s; }
        .big-btn:disabled { opacity: 0.2; filter: grayscale(100%); pointer-events: none; }
        
        .b-wrong { background:var(--danger); }
        .b-bank { background:var(--accent); color:black; display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1; }
        .b-correct { background:var(--success); color:black; }

        .host-penalties { display:none; flex-direction: column; width: 100%; gap: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-top: 10px; }
        .p-row { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .p-name { width: 60px; text-align: right; font-weight: bold; font-size: 0.9rem; color: var(--primary); }
        .ovals-wrapper { display: flex; gap: 5px; }
        .oval { width: 25px; height: 25px; border-radius: 50%; border: 2px solid #555; background: #222; }
        .oval.correct { background: var(--success); border-color: var(--success); }
        .oval.wrong { background: var(--danger); border-color: var(--danger); }
        .oval.current { border-color: var(--accent); transform: scale(1.2); }

        select { width:100%; padding:10px; background:#222; color:white; border:1px solid #444; border-radius:5px; flex-shrink: 0; }
        
        .stat-header { display:flex; justify-content:space-between; font-size:0.8rem; color:#888; border-bottom:1px solid #555; padding:5px; margin-bottom:5px; }
        .stat-row { display:flex; justify-content:space-between; font-size:0.9rem; border-bottom:1px solid #333; padding:8px 0; }
        .col-name { flex: 2; font-weight: bold; }
        .col-data { flex: 1; text-align: center; }
        .col-money { flex: 1.2; text-align: right; color: var(--accent); }
        
        .row-strongest { color: var(--success); }
        .row-strongest .col-name::after { content: ' ‚òÖ'; }
        .row-weakest { color: var(--danger); }
        .row-weakest .col-name::after { content: ' ‚ñº'; }

        #audioDebug { font-size: 0.7rem; color: #555; position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.8); padding: 5px; border-radius: 5px; pointer-events: none; }
        @keyframes fadeIn { from{opacity:0; transform: translateY(20px);} to{opacity:1; transform: translateY(0);} }
    </style>
</head>
<body>
    <header>
        <div class="brand">HOST CONTROL</div>
        <div id="audioDebug">Audio: Esperando...</div>
        <div class="timer-box">‚è± <span id="timerDisplay">03:00</span></div>
        <div class="bank-box">
            <div class="bank-row">
                <span class="bank-label">RONDA</span>
                <span id="bankRoundDisplay" class="bank-val">$0</span>
            </div>
            <div class="bank-row">
                <span class="bank-label">TOTAL</span>
                <span id="bankTotalDisplay" class="bank-val total-val">$0</span>
            </div>
        </div>
    </header>

    <div class="main-grid">
        <div class="panel">
            <small style="color:#888">CONTROL PRINCIPAL</small>
            <button id="btnIntro" class="btn btn-intro" onclick="playAudioFile('intro.mp3')">üé§ HOST LISTO (INTRO)</button>
            <button id="btnJuguemos" class="btn btn-phrase" onclick="playSfx('juguemos')">üì¢ Juguemos a el rival m√°s d√©bil</button>

            <button class="btn" style="background: #ff9800; color: white;" onclick="stopPlaticaOnly()">üîá SILENCIAR SONIDO</button>
            <button class="btn" style="background: #0056b3; color: white;" onclick="playAudioFile('platica.mp3', true)">üîä PLAY PL√ÅTICA</button>
            
            <small style="color:#888; margin-top:5px;">FASES</small>
            <button id="btnPhaseWait" class="btn" onclick="setPhase('waiting')">‚è∏ ESPERA</button>
            <button id="btnPhaseQ" class="btn" onclick="setPhase('questions')">‚ñ∂ PREGUNTAS</button>
            <button id="btnPhaseVote" class="btn" onclick="setPhase('voting')">üó≥ VOTACI√ìN</button>
            <button id="btnPhaseElim" class="btn btn-danger" onclick="setPhase('elimination')">‚ò† ELIMINACI√ìN</button>
            <button id="btnPhasePen" class="btn" disabled style="background: linear-gradient(45deg, #FFD700, #DAA520); color:black; margin-top:10px;" onclick="setPhase('penalty')">üèÜ GRAN FINAL</button>
            
            <div style="margin-top: 20px;">
                <small style="color:#888">RONDA</small>
                <div id="roundDisplay" style="font-size:1.5rem; font-weight:bold">1</div>
            </div>
            <button class="btn btn-reset" onclick="resetGame()">üîÑ RESET TOTAL</button>
        </div>

        <div class="panel center-panel">
            <div id="turnDisplay" class="turn-banner">TURNO DE: --</div>

            <div id="questionArea" class="question-area">
                <div id="qCategory" class="cat-text">CATEGOR√çA</div>
                <div id="questionText" class="q-text">Esperando inicio...</div>
                <div id="answerText" class="a-text">Respuesta</div>
                
                <div id="winnerBanner" class="winner-banner">
                    <div class="wb-title">‚ú® ¬°TENEMOS UN GANADOR! ‚ú®</div>
                    <div id="winnerName" class="wb-name">NOMBRE</div>
                    <div class="wb-amount-label">PREMIO ACUMULADO</div>
                    <div id="winnerAmount" class="wb-amount">$0</div>
                </div>
            </div>

            <div id="preFinalArea" class="pre-final-msg">
                <div class="pf-text">ES MOMENTO<br>DE LA FINAL</div>
            </div>

            <div id="hostPenalties" class="host-penalties">
                <div class="p-row">
                    <div id="penP1Name" class="p-name">P1</div>
                    <div id="penP1Ovals" class="ovals-wrapper"></div>
                </div>
                <div class="p-row">
                    <div id="penP2Name" class="p-name">P2</div>
                    <div id="penP2Ovals" class="ovals-wrapper"></div>
                </div>
            </div>

            <div id="votingResultsArea" class="voting-area">
                <h3 style="text-align:center; margin:0 0 10px 0;">RESULTADOS VOTACI√ìN</h3>
                <div id="alertElim" class="vote-alert alert-elim">ELIMINAR A: <span id="elimTarget">--</span></div>
                <div id="alertTie" class="vote-alert alert-tie">¬°EMPATE! DECIDE: <span id="tieBreaker">--</span></div>
                <div id="votesList"></div>
            </div>
            
            <div id="hostLadder"></div>

            <div class="controls-area">
                <button id="btnWrong" class="big-btn b-wrong" onclick="socket.emit('wrongAnswer'); playSfx('wrong')">‚úñ MAL</button>
                <button id="btnBank" class="big-btn b-bank" onclick="socket.emit('bank');">
                    <span>üí∞ BANCA</span>
                    <span id="bankBtnVal" style="font-size: 0.9rem; margin-top: 2px;">$0</span>
                </button>
                <button id="btnCorrect" class="big-btn b-correct" onclick="socket.emit('correctAnswer'); playSfx('correct')">‚úî BIEN</button>
            </div>
        </div>

        <div class="panel">
            <small style="color:#888">ELIMINAR</small>
            <select id="eliminationSelect"><option value="">Selecciona...</option></select>
            <button class="btn btn-danger" style="text-align:center; margin-top:5px; flex-shrink:0;" onclick="eliminate()">ELIMINAR</button>
            <hr style="border:0; border-top:1px solid #333; width:100%">
            
            <small style="color:#888">RANKING</small>
            <div class="stat-header">
                <span style="flex:2">JUG</span>
                <span style="flex:1; text-align:center">‚úî</span>
                <span style="flex:1; text-align:center">‚úñ</span>
                <span style="flex:1.2; text-align:right">üí≤</span>
            </div>
            <div id="rankingList" style="overflow-y:auto; flex:1;"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let activePlayersCount = 0; 
        let activePhase = 'waiting'; 
        let currentRound = 1;
        let isGameOver = false; // BANDERA PARA PROTEGER AL GANADOR

        // --- MOTOR DE AUDIO ---
        let currentMusic = null;
        let currentFileName = "";
        const debugEl = document.getElementById('audioDebug');

        function updateDebug(msg, color='#fff') {
            debugEl.innerText = "Audio: " + msg;
            debugEl.style.color = color;
        }

        // playAudioFile: Ahora acepta "mix" para NO pausar el anterior (empalmar)
        function playAudioFile(fileName, loop = false) {
            // EL ESCUDO: Si el archivo que quieres tocar es el mismo que ya suena, NO HAGAS NADA
            if (currentMusic && currentFileName === fileName && !currentMusic.paused) {
                return; 
            }

            // Si es un archivo nuevo, entonces s√≠ paramos el anterior y tocamos el nuevo
            if (currentMusic) {
                currentMusic.pause();
                currentMusic.currentTime = 0;
            }
            
            const path = '/SOUNDS/' + fileName;
            updateDebug("Intentando: " + fileName, "#0ff");
            
            const sound = new Audio(path);
            sound.loop = loop;
            sound.volume = 0.5; 
            
            sound.play()
                .then(() => {
                    updateDebug("Reproduciendo: " + fileName, "#0f0");
                    currentFileName = fileName; // Guardamos el nombre del archivo actual
                })
                .catch(e => updateDebug("ERROR: " + e.message, "#f00"));
                
            sound.onerror = () => updateDebug("ERROR: No encontrado " + fileName, "#f00");
            
            currentMusic = sound;
        }

        function forceTotalSilence() {
    // 1. Detenemos la referencia principal si existe
    if (currentMusic) {
        currentMusic.pause();
        currentMusic.currentTime = 0;
        currentMusic.onended = null;
        currentMusic = null;
    }

    // 2. Buscamos TODOS los objetos de audio creados en el documento y los matamos
    const allAudios = document.getElementsByTagName('audio');
    for (let i = 0; i < allAudios.length; i++) {
        allAudios[i].pause();
        allAudios[i].currentTime = 0;
    }

    // 3. Reset de variables de control
    currentFileName = "";
    
    // 4. Limpiamos cualquier "cadena" de audios pendientes
    updateDebug("¬°SILENCIO TOTAL ACTIVADO!", "#ff0000");
}

        function playRoundMusic() {
            let seconds = 0;
            if (activePlayersCount === 2) seconds = 90; 
            else seconds = 180 - ((currentRound - 1) * 10);
            
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const id = `${mins}${secs.toString().padStart(2, '0')}`;
            const fileName = `timer_${id}.mp3`;
            
            playAudioFile(fileName, false);
        }
        
        const sfx = {
            correct: new Audio('/SOUNDS/correct.mp3'),
            wrong: new Audio('/SOUNDS/wrong.mp3'),
            bank: new Audio('/SOUNDS/bank.mp3'),
            eliminado: new Audio('/SOUNDS/eliminado.mp3'),
            ganador: new Audio('/SOUNDS/ganador.mp3'),
            juguemos: new Audio('/SOUNDS/juguemos.mp3'),
            votando: new Audio('/SOUNDS/votando.mp3')
        };

        function playSfx(name) {
            if (sfx[name]) {
                sfx[name].currentTime = 0;
                sfx[name].play().catch(e => {});
            }
        }

        function stopPlaticaOnly() {
    // Buscamos todos los elementos de audio que el navegador ha creado
    const allAudios = document.querySelectorAll('audio');
    
    allAudios.forEach(audio => {
        // Verificamos si la fuente del archivo incluye 'platica'
        if (audio.src.includes('platica.mp3')) {
            audio.pause();
            audio.currentTime = 0; // Reiniciamos el tiempo
            updateDebug("Pl√°tica silenciada", "#ff9800");
        }
    });

    // Tambi√©n limpiamos la referencia si era la m√∫sica principal actual
    if (currentFileName === 'platica.mp3') {
        currentMusic = null;
        currentFileName = "";
    }
}

        // --- SECUENCIA DE FINAL ---
        function playFinalSequence() {
            stopMusic(); 
            playAudioFile('anuncio_final.mp3', false, false, 'jugando_final.mp3');
        }

        function stopMusic() {
            if (currentMusic) {
                currentMusic.pause();
                currentMusic.currentTime = 0;
                currentMusic.onended = null;
                currentMusic = null;
                currentFileName = ""; 
                updateDebug("Silencio", "#888");
            }
        }

        const els = {
            timer: document.getElementById('timerDisplay'),
            bankTotal: document.getElementById('bankTotalDisplay'),
            bankRound: document.getElementById('bankRoundDisplay'),
            qCat: document.getElementById('qCategory'),
            qText: document.getElementById('questionText'),
            aText: document.getElementById('answerText'),
            winnerBanner: document.getElementById('winnerBanner'),
            winnerName: document.getElementById('winnerName'),
            winnerAmount: document.getElementById('winnerAmount'),
            turn: document.getElementById('turnDisplay'),
            round: document.getElementById('roundDisplay'),
            rank: document.getElementById('rankingList'),
            elSelect: document.getElementById('eliminationSelect'),
            hLadder: document.getElementById('hostLadder'),
            bankBtnVal: document.getElementById('bankBtnVal'),
            qArea: document.getElementById('questionArea'),
            vArea: document.getElementById('votingResultsArea'),
            preFinal: document.getElementById('preFinalArea'), 
            vList: document.getElementById('votesList'),
            alertElim: document.getElementById('alertElim'),
            alertTie: document.getElementById('alertTie'),
            elimTarget: document.getElementById('elimTarget'),
            tieBreaker: document.getElementById('tieBreaker'),
            btnWait: document.getElementById('btnPhaseWait'),
            btnQ: document.getElementById('btnPhaseQ'),
            btnVote: document.getElementById('btnPhaseVote'),
            btnElim: document.getElementById('btnPhaseElim'),
            btnPen: document.getElementById('btnPhasePen'),
            gameBtns: [document.getElementById('btnWrong'), document.getElementById('btnBank'), document.getElementById('btnCorrect')],
            btnBankOnly: document.getElementById('btnBank'),
            hostPens: document.getElementById('hostPenalties'),
            p1Name: document.getElementById('penP1Name'),
            p1Ovals: document.getElementById('penP1Ovals'),
            p2Name: document.getElementById('penP2Name'),
            p2Ovals: document.getElementById('penP2Ovals')
        };

        function setPhase(p) { if(!isGameOver) socket.emit('setPhase', p); }
        function eliminate() {
            const val = els.elSelect.value;
            if(val && confirm(`¬øEliminar a ${val}?`)) {
                socket.emit('eliminatePlayer', val);
            }
        }
        function resetGame() { if(confirm("‚ö† REINICIAR TODO?")) socket.emit('resetGame'); }

        socket.on('timerUpdate', t => {
            const minutes = Math.floor(t / 60);
            const seconds = t % 60;
            els.timer.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        });
        
        socket.on('phaseChanged', phase => {
            // SI EL JUEGO ACAB√ì, NO PERMITIMOS CAMBIOS VISUALES QUE OCULTEN AL GANADOR
            if (isGameOver) return; 

            activePhase = phase;

            // --- L√ìGICA DE AUDIO AJUSTADA ---

            if (phase === 'questions') {
                playRoundMusic(); 
            }
            
            else if (phase === 'times_up') {
                // Ya no necesitamos llamar a playAudioFile aqu√≠ 
                // porque el timer_xxx.mp3 tiene un onended que llama a platica.mp3
                updateDebug("Tiempo agotado - Entrando pl√°tica", "#ffcc00");
            }

            else if (phase === 'voting') {
                playSfx('votando');
                // No paramos platica.mp3
            }
            
            else if (phase === 'waiting') {
                // CORRECCI√ìN 2: No paramos m√∫sica en espera para que siga sonando Platica
                // Solo si venimos de un reset podr√≠amos parar, pero por flujo normal, dejamos sonar.
            }

            else if (phase === 'final_intro') {
                playFinalSequence();
            }
            
            // --- ACTUALIZACI√ìN VISUAL ---
            els.winnerBanner.style.display = 'none'; 
            els.qCat.style.display = 'block';
            els.qText.style.display = 'block';
            els.aText.style.display = 'block';
            els.preFinal.style.display = 'none'; 

            [els.btnWait, els.btnQ, els.btnVote, els.btnElim, els.btnPen].forEach(b => {
                b.classList.remove('active', 'btn-next-step');
                b.disabled = false;
            });
            
            if (phase === 'penalty') els.hostPens.style.display = 'flex';
            else els.hostPens.style.display = 'none';

            if(phase === 'voting' || phase === 'times_up') {
                els.qArea.style.display = 'none';
                if (activePlayersCount === 2) {
                    els.vArea.style.display = 'none'; 
                    els.preFinal.style.display = 'flex'; 
                } else {
                    els.vArea.style.display = 'block'; 
                    els.preFinal.style.display = 'none';
                }
            } else {
                els.qArea.style.display = 'flex';
                els.vArea.style.display = 'none';
                els.alertElim.style.display = 'none';
                els.alertTie.style.display = 'none';
            }

            if (phase === 'waiting') {
                els.btnWait.classList.add('active');
                els.btnQ.classList.add('btn-next-step');
                els.gameBtns.forEach(b => b.disabled = true);
            } 
            else if (phase === 'questions') {
                els.btnQ.classList.add('active');
                els.btnVote.classList.add('btn-next-step');
                els.gameBtns.forEach(b => b.disabled = false);
            } 
            else if (phase === 'voting' || phase === 'times_up') {
                els.btnVote.classList.add('active');
                els.btnElim.classList.add('btn-next-step');
                els.gameBtns.forEach(b => b.disabled = true);
            } 
            else if (phase === 'elimination') {
                els.btnElim.classList.add('active');
                els.btnQ.classList.add('btn-next-step');
                els.gameBtns.forEach(b => b.disabled = true);
            }
            else if (phase === 'penalty') {
                els.btnPen.classList.add('active');
                els.gameBtns.forEach(b => b.disabled = false);
                els.btnBankOnly.disabled = true;
            }
        });

        socket.on('finalWinner', data => {
            isGameOver = true; // BLOQUEAR CAMBIOS DE FASE
            stopMusic();
            playSfx('ganador');
            
            // Forzar vista del banner
            els.qArea.style.display = 'flex'; 
            els.qCat.style.display = 'none';
            els.qText.style.display = 'none';
            els.aText.style.display = 'none';

            els.winnerBanner.style.display = 'flex';
            els.winnerName.innerText = data.name; 
            els.winnerAmount.innerText = `$${data.amount}`;
            
            els.gameBtns.forEach(b => b.disabled = true);
        });

        socket.on('bankState', s => {
            const currentVal = parseInt(els.bankTotal.innerText.replace('$','')) || 0;
            if (s.bankedTotal > currentVal) playSfx('bank');
            els.bankTotal.innerText = `$${s.bankedTotal}`;
            els.bankRound.innerText = `$${s.bankedRound}`;
            els.bankBtnVal.innerText = `$${s.currentChainValue}`;
            els.hLadder.innerHTML = '';
            s.chain.forEach((val, idx) => {
                const div = document.createElement('div');
                div.className = `h-step ${idx === s.chainIndex ? 'active' : ''}`;
                div.innerText = `$${val}`;
                els.hLadder.appendChild(div);
            });
        });
        
        socket.on('questionUpdate', q => { 
            if(q) { 
                els.qCat.innerText = q.category || "GENERAL";
                els.qText.innerText = q.question; 
                els.aText.innerText = q.answer; 
            } else { 
                els.qCat.innerText = "";
                els.qText.innerText = "Esperando pregunta..."; 
                els.aText.innerText = ""; 
            }
        });
        
        socket.on('turnUpdate', p => {
            if (activePhase === 'waiting') {
                els.turn.innerText = `COMIENZA: ${p || "Esperando jugadores..."}`;
                els.turn.style.background = "rgba(255, 64, 129, 0.2)"; 
                els.turn.style.border = "1px solid #ff4081";
            } else {
                els.turn.innerText = `TURNO DE: ${p || "--"}`;
                els.turn.style.background = "rgba(0, 210, 255, 0.1)"; 
                els.turn.style.border = "1px solid var(--primary)";
            }
        });

        socket.on('roundUpdate', r => { currentRound = r; els.round.innerText = r; });
        
        socket.on('playersUpdated', players => {
            activePlayersCount = players.length; 
            els.elSelect.innerHTML = '<option value="">Selecciona...</option>';
            players.forEach(p => els.elSelect.innerHTML += `<option value="${p}">${p}</option>`);
            if (players.length === 2) els.btnPen.disabled = false;
            else els.btnPen.disabled = true;
        });

        socket.on('rankingUpdate', list => {
            list.sort((a,b) => b.correct - a.correct);
            els.rank.innerHTML = list.map((p, index) => {
                let rowClass = "";
                if (list.length > 1) {
                    if (index === 0) rowClass = "row-strongest";
                    if (index === list.length - 1) rowClass = "row-weakest";
                }
                return `
                <div class="stat-row ${rowClass}">
                    <span class="col-name">${p.name}</span>
                    <span class="col-data">${p.correct}</span>
                    <span class="col-data">${p.wrong}</span>
                    <span class="col-money">$${p.bankAmount}</span>
                </div>`;
            }).join('');
        });

        socket.on('votesUpdated', data => {
            els.vList.innerHTML = data.details.map(v => `
                <div class="vote-card">
                    <span class="voter-name">${v.voter} vot√≥ por...</span>
                    <span class="target-name">${v.target}</span>
                </div>
            `).join('');
        });

        socket.on('votingResult', res => {
            if(!res) {
                els.alertElim.style.display = 'none';
                els.alertTie.style.display = 'none';
                return;
            }
            if(res.type === 'clear') {
                els.alertElim.style.display = 'block';
                els.elimTarget.innerText = `${res.target} (${res.count} votos)`;
            } else if (res.type === 'tie') {
                els.alertTie.style.display = 'block';
                els.tieBreaker.innerText = res.decisionMaker;
            }
        });
        
        // SONIDO ELIMINADO: Se mezcla encima de 'platica.mp3' (porque no paramos m√∫sica en waiting)
             socket.on('playerEliminated', (name) => {
            playSfx('eliminado');
            updateDebug(`SALI√ì: ${name}`, "#ff0055");
        });

        socket.on('finalState', final => {
            els.p1Name.innerText = final.p1.name;
            els.p2Name.innerText = final.p2.name;
            els.p1Ovals.innerHTML = '';
            const maxSlots = Math.max(5, final.p1.history.length + 1);
            for(let i=0; i<maxSlots; i++) {
                const div = document.createElement('div');
                div.className = 'oval';
                if (i < final.p1.history.length) div.classList.add(final.p1.history[i] ? 'correct' : 'wrong');
                else if (i === final.p1.history.length && final.turn === 0) div.classList.add('current');
                els.p1Ovals.appendChild(div);
            }
            els.p2Ovals.innerHTML = '';
            const maxSlots2 = Math.max(5, final.p2.history.length + 1);
            for(let i=0; i<maxSlots2; i++) {
                const div = document.createElement('div');
                div.className = 'oval';
                if (i < final.p2.history.length) div.classList.add(final.p2.history[i] ? 'correct' : 'wrong');
                else if (i === final.p2.history.length && final.turn === 1) div.classList.add('current');
                els.p2Ovals.appendChild(div);
            }
        });

        socket.on('gameReset', () => {
            stopMusic();
            location.reload();
        });
    </script>
</body>
</html>






